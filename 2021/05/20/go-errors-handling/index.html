<!DOCTYPE html><html lang="zh-CN"><head><title>Go Errors Handling</title><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/css/highlight/xcode.min.css"><link rel="stylesheet" href="/css/bootstrap/bootstrap-tooltips.css"><link rel="stylesheet" href="/css/post.css"><script src="/js/jquery.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><script>if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) {
  document.body.classList.add('mobile')
}</script><div><div class="inner"><h2>Go Errors Handling</h2><p>å¦‚ä½•æ­£ç¡®è€Œä¼˜é›…åœ°å¤„ç†é”™è¯¯æ˜¯æ¯ä¸ª Go ç¨‹åºå‘˜éƒ½è¦æ€è€ƒçš„ä¸€ä¸ªé—®é¢˜ã€‚Go å¤„ç†é”™è¯¯çš„æ–¹å¼ä¸åŒäºä¸»æµè¯­è¨€ï¼Œä¸åƒ Java ä½¿ç”¨ <code>try catch finally</code> è¯­å¥å»å¤„ç†ç¨‹åºçš„å¼‚å¸¸/é”™è¯¯ï¼ŒGo ä¸­æ²¡æœ‰è¿™æ ·çš„é”™è¯¯å¤„ç†è¯­å¥ã€‚</p>
<p>åœ¨ Go ä¸­ï¼Œé”™è¯¯å¤„ç†æ„å‘³ç€æ£€æŸ¥é”™è¯¯å€¼å¹¶åšå‡ºå†³å®šï¼ŒGo é”™è¯¯å¤„ç†çš„ç²¾é«“æ˜¯åŸºäºå…¶ä»¥ä¸‹è¯­è¨€ç‰¹æ€§ï¼š</p>
<a id="more"></a>

<ol>
<li>errors are valuesã€‚åœ¨ Go ä¸­é”™è¯¯å°±æ˜¯å€¼ï¼Œå°±åƒ <code>&quot;hello world&quot;</code> ä¹‹äº <code>string</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨å˜é‡å»æ‰¿è½½é”™è¯¯ã€‚Go ç”¨æˆ·å¿…é¡»æ£€æŸ¥å‡½æ•°è¿”å›çš„é”™è¯¯çš„å€¼ï¼Œç»“åˆ <code>if else</code> æˆ–è€… <code>switch case</code> è¯­å¥å»åšæµç¨‹æ§åˆ¶ï¼ˆç»ˆæ­¢ç¨‹åºæ‰§è¡Œæµç¨‹ã€ç»§ç»­æ‰§è¡Œæµç¨‹ï¼‰ï¼›</li>
<li>å‡½æ•°å¯ä»¥æœ‰å¤šä¸ªè¿”å›å€¼ï¼Œå¦‚æœå‡½æ•°è¦è¿”å›é”™è¯¯ï¼Œé‚£ä¹ˆæœ€ä½³å®è·µæ˜¯æŠŠé”™è¯¯æ”¾åœ¨å¤šä¸ªè¿”å›å€¼ä¸­çš„æœ€åä¸€ä¸ªï¼Œå½¢å¦‚è¿™ä¸ªå‡½æ•°ç­¾åï¼š<code>func func1() (int, int, error)</code>ã€‚è¿™ä¸€ç‚¹éå¸¸æ˜¾è€Œæ˜“è§ï¼Œä»¥è‡³äºå¾ˆå¤šäººå¸¸å¸¸å¿½ç•¥æ‰è¿™ä¸ªç‰¹æ€§åœ¨é”™è¯¯å¤„ç†ä¸­çš„å­˜åœ¨ã€‚</li>
</ol>
<p>è¿™ä¹Ÿæ˜¯å…¶å®ƒè¯­è¨€çš„ç”¨æˆ·ä½¿ç”¨ Go è¯­è¨€æ—¶ç»å¸¸è°ˆåˆ°çš„ï¼ˆå¥½çš„ã€åçš„ï¼‰ï¼Œæœ‰äººä¼šè®¤ä¸ºè¿™ç§å¤„ç†æ–¹å¼å¯¼è‡´ä»£ç é‡Œæœ‰å¤ªå¤šç¹ççš„ã€é‡å¤çš„ <code>if err â‰  nil &#123;&#125;</code>ã€‚å…³äºå¦‚ä½•å¤„ç†é”™è¯¯çš„è®¨è®ºæœ‰å¾ˆå¤šï¼Œè¿™ä¸ªè¯é¢˜ä¹Ÿæˆä¸ºäº†å¾ˆå¤šæ¼”è®²è€…çš„æ¼”è®²ä¸»é¢˜ã€‚æœ¬æ–‡ç”±æµ…å…¥æ·±ï¼Œæ€»ç»“ä¸€ä¸‹é”™è¯¯å¤„ç†çš„ç»éªŒã€‚</p>
<h2 id="Error-çš„å¤„ç†ç­–ç•¥"><a href="#Error-çš„å¤„ç†ç­–ç•¥" class="headerlink" title="Error çš„å¤„ç†ç­–ç•¥"></a>Error çš„å¤„ç†ç­–ç•¥</h2><p>Go ä»£ç ä¸­å¸¸è§çš„é”™è¯¯å¤„ç†ç­–ç•¥æœ‰ä¸‰ç§ï¼š</p>
<ol>
<li>Sentinel errors</li>
<li>Error types</li>
<li>Opaque errors</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘å°†ä¸€ä¸€ä»‹ç»å®ƒä»¬ï¼Œæè¿°å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œæœ€åæ€»ç»“å‡ºä¸€ä¸ªæˆ‘æ„¿æ„åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„é”™è¯¯å¤„ç†å®è·µã€‚</p>
<h2 id="Sentinel-errors"><a href="#Sentinel-errors" class="headerlink" title="Sentinel errors"></a>Sentinel errors</h2><p>é¢„å®šä¹‰çš„ã€å€¼ç­‰äºç‰¹å®šå€¼çš„é”™è¯¯ï¼Œç§°ä¸º sentinel errorsã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯å½“æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªé”™è¯¯å€¼ï¼Œæ‹¿å®ƒè·Ÿç›®æ ‡ sentinel error åšç­‰å€¼æ¯”è¾ƒï¼š</p>
<pre><code class="go">package a

// å®šä¹‰ sentinal errorï¼Œä¸€èˆ¬æ˜¯å¯¼å‡ºçš„
var SomeError = errors.New(&quot;something bad happened&quot;)

// someFunc æ˜¯ä¸€ä¸ªä»»æ„å‡½æ•°ï¼Œå®ƒå¯èƒ½ä¼šè¿”å› SomeError
func someFunc() error &#123;
    var expect, got int
    // ç»è¿‡ä¸€ç³»åˆ—å¤„ç†...
    if a != b &#123;
        return SomeError
    &#125;
    // ...
    return nil
&#125;

// ====== åˆ†å‰²çº¿ ======

package b

import &quot;a&quot;

// someFunc çš„è°ƒç”¨æ–¹å…³å¿ƒå¾—åˆ°çš„ err æ˜¯ä¸æ˜¯ SomeErrorï¼Œå› æ­¤éœ€è¦åšä¸€ä¸ªç­‰å€¼æ¯”è¾ƒ
err := someFunc()
if err == SomeError &#123;
    // å¦‚æœæ˜¯ SomeErrorï¼Œé‚£ä¹ˆåšä¸€äº›å¤„ç†
&#125;</code></pre>
<p>Sentinel errors æ˜¯æœ€ä¸çµæ´»çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œå› ä¸ºè°ƒç”¨æ–¹å¿…é¡»ä½¿ç”¨ <code>==</code> å°†ç»“æœä¸é¢„å…ˆå£°æ˜çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å½“ä½ æƒ³è¦æä¾›æ›´å¤šçš„ä¸Šä¸‹æ–‡æ—¶ï¼Œè¿™å°±å‡ºç°é—®é¢˜ï¼Œå› ä¸ºè¿”å›ä¸€ä¸ªä¸åŒçš„é”™è¯¯å€¼å°†ç ´åç°æœ‰çš„ç›¸ç­‰æ€§æ£€æŸ¥ã€‚ç”šè‡³æ˜¯ä¸€äº›æœ‰æ„ä¹‰çš„ <code>fmt.Errorf()</code> æºå¸¦ä¸€äº›ä¸Šä¸‹æ–‡ï¼Œä¹Ÿä¼šç ´åè°ƒç”¨è€…çš„ <code>==</code>ï¼Œè°ƒç”¨è€…å°†è¢«è¿«æŸ¥çœ‹ <code>error.Error()</code> æ–¹æ³•çš„è¾“å‡ºï¼Œä»¥æŸ¥çœ‹å®ƒæ˜¯å¦è·Ÿç‰¹å®šçš„å­—ç¬¦ä¸²åŒ¹é…ã€‚ä½†æˆ‘ä»¬ä¸åº”è¯¥ä¾èµ–æ£€æµ‹ <code>error.Error()</code> çš„è¾“å‡ºï¼Œ<code>error.Error()</code>æ–¹æ³•å­˜åœ¨äº <code>error</code> æ¥å£ä¸»è¦ç”¨æˆ·æ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç¨‹åºã€‚è¿™ä¸ªè¾“å‡ºçš„å­—ç¬¦ä¸²åªæ˜¯ç”¨æ¥æ–¹ä¾¿ç”¨æˆ·è®°å½•æ—¥å¿—ã€è¾“å‡ºåˆ° stdout ç­‰ã€‚</p>
<p>Sentinel errors çš„å¼Šç«¯ï¼š</p>
<ol>
<li>Sentinel errors æˆä¸ºäº†ä½  API çš„å…¬å…±éƒ¨åˆ†ã€‚å¦‚æœä½ çš„å…¬å…±å‡½æ•°æˆ–æ–¹æ³•è¿”å›ä¸€ä¸ªç‰¹å®šå€¼çš„é”™è¯¯ï¼Œé‚£ä¹ˆè¯¥å€¼å¿…é¡»æ˜¯å…¬å…±çš„ï¼Œå½“ç„¶è¦æœ‰æ–‡æ¡£è®°å½•ï¼Œå¢åŠ äº† API çš„è¡¨é¢ç§¯ã€‚å¦‚æœ API å®šä¹‰äº†ä¸€ä¸ªè¿”å›ç‰¹å®šé”™è¯¯çš„ <code>interface</code>ï¼Œåˆ™è¯¥æ¥å£çš„æ‰€æœ‰å®ç°éƒ½å°†è¢«é™åˆ¶ä¸ºè¿”å›è¯¥é”™è¯¯ï¼Œå³ä½¿å®ƒä»¬å¯ä»¥æä¾›æ›´å…·æè¿°æ€§çš„é”™è¯¯ã€‚æ¯”å¦‚ <code>io.Reader</code>ï¼Œåƒ <code>io.Copy</code> è¿™ç±»å‡½æ•°éœ€è¦ <code>reader</code> çš„å®ç°è€…æ¯”å¦‚è¿”å› <code>io.EOF</code> æ¥å‘Šè¯‰è°ƒç”¨è€…æ²¡æœ‰æ›´å¤šæ•°æ®äº†ï¼Œä½†è¿™åˆä¸æ˜¯é”™è¯¯ã€‚</li>
<li>Sentinel errors åœ¨ä¸¤ä¸ªåŒ…ä¹‹é—´åˆ›å»ºäº†ä¾èµ–ã€‚Sentinel errors æœ€ç³Ÿç³•çš„é—®é¢˜æ˜¯å®ƒä»¬åœ¨ä¸¤ä¸ªåŒ…ä¹‹é—´åˆ›å»ºäº†æºä»£ç ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œæ£€æŸ¥é”™è¯¯æ˜¯å¦ç­‰äº <code>io.EOF</code> ï¼Œä½ çš„ä»£ç å¿…é¡»å¯¼å…¥ <code>io</code> åŒ…ã€‚è¿™ä¸ªç‰¹å®šçš„ä¾‹å­å¬èµ·æ¥å¹¶ä¸é‚£ä¹ˆç³Ÿç³•ï¼Œå› ä¸ºå®ƒéå¸¸å¸¸è§ï¼Œä½†æ˜¯æƒ³è±¡ä¸€ä¸‹ï¼Œå½“é¡¹ç›®ä¸­çš„è®¸å¤šåŒ…å¯¼å‡ºé”™è¯¯å€¼æ—¶ï¼ŒåŒ…ä¸åŒ…ä¹‹é—´å­˜åœ¨è€¦åˆï¼Œé¡¹ç›®ä¸­çš„å…¶ä»–åŒ…å¿…é¡»å¯¼å…¥è¿™äº›é”™è¯¯å€¼æ‰èƒ½æ£€æŸ¥ç‰¹å®šçš„é”™è¯¯æ¡ä»¶ã€‚</li>
</ol>
<p>ç»“è®ºï¼šå°½å¯èƒ½é¿å… sentinel errorsã€‚æˆ‘çš„å»ºè®®æ˜¯é¿å…åœ¨ç¼–å†™çš„ä»£ç ä¸­ä½¿ç”¨ sentinel errorsã€‚åœ¨æ ‡å‡†åº“ä¸­æœ‰ä¸€äº›ä½¿ç”¨å®ƒä»¬çš„æƒ…å†µï¼Œä½†è¿™ä¸æ˜¯ä¸€ä¸ªæˆ‘ä»¬åº”è¯¥æ¨¡ä»¿çš„æ¨¡å¼ã€‚</p>
<h2 id="Error-types"><a href="#Error-types" class="headerlink" title="Error types"></a>Error types</h2><p>Error types æ˜¯å®ç°äº† error æ¥å£çš„è‡ªå®šä¹‰ç±»å‹ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="go">type MyError struct &#123;
    Msg  string
    File string
    Line int
&#125;

func (e *MyError) Error() string &#123;
    return fmt.Sprintf(&quot;%s:%d:%s&quot;, e.File, e.Line, e.Msg)
&#125;

func test() error &#123;
    return &amp;MyError&#123;&quot;Something happened&quot;, &quot;server.go&quot;, 42&#125;
&#125;</code></pre>
<p>å› ä¸º <code>MyError</code> æ˜¯ä¸€ä¸ª typeï¼Œè°ƒç”¨è€…å¯ä»¥ä½¿ç”¨æ–­è¨€è½¬æ¢æˆè¿™ä¸ªç±»å‹ï¼Œæ¥è·å–æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š</p>
<pre><code class="go">func main() &#123;
    err := test()
    switch err := err.(type) &#123;
        case nil:
            // call succeeded, nothing to do
        case *MyError:
            fmt.Println(&quot;error occurred on line: &quot;, err.line)
        default:
            // unknown error
    &#125;
&#125;</code></pre>
<p>Error types è§£å†³äº† sentinel errors çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¸¦æ¥äº†ä»¥ä¸‹æ”¹è¿›ï¼š</p>
<ol>
<li>é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ›´ä¸°å¯Œã€‚è€Œ sentinel error çš„å€¼æ˜¯å›ºå®šçš„ï¼Œåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å·²ç»åˆå§‹åŒ–ï¼ŒåŸºæœ¬æ²¡æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåªæ˜¯ä¸€ä¸ªâ€œå“¨å…µâ€œï¼›</li>
</ol>
<p>ä¸€ä¸ªä¸é”™çš„ä¾‹å­æ˜¯ <code>os.PathError</code>ï¼Œå®ƒæä¾›äº†åº•å±‚æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œã€å“ªä¸ªè·¯å¾„å‡ºäº†é—®é¢˜ï¼š</p>
<pre><code class="go">// PathError records an error and the operation and file path that caused it.
type PathError struct &#123;
    Op   string
    Path string
    Err  error
&#125;

func (e *PathError) Error() string &#123; return e.Op + &quot; &quot; + e.Path + &quot;: &quot; + e.Err.Error() &#125;

func (e *PathError) Unwrap() error &#123; return e.Err &#125;</code></pre>
<p>è™½ç„¶ error types ä¸ºé”™è¯¯æä¾›è¯¦ç»†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå½“ä»ç„¶å­˜åœ¨é—®é¢˜ï¼šè°ƒç”¨è€…éœ€è¦ä½¿ç”¨ç±»å‹æ–­è¨€å’Œç±»å‹ switchï¼Œéœ€è¦è®©è‡ªå®šä¹‰çš„é”™è¯¯å˜ä¸º publicã€‚è¿™å¯¼è‡´å’Œè°ƒç”¨è€…äº§ç”Ÿå¼ºè€¦åˆï¼Œä»è€Œå¯¼è‡´APIå˜å¾—è„†å¼±ã€‚</p>
<p>ç»“è®ºï¼šå°½é‡é¿å…ä½¿ç”¨ error typesï¼Œè™½ç„¶é”™è¯¯ç±»å‹æ¯” sentinel errors æ›´å¥½ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ•è·å…³äºå‡ºé”™çš„æ›´å¤šä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯ error types æœ‰ç€å’Œ error values è®¸å¤šç›¸åŒçš„é—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘çš„å»ºè®®æ˜¯é¿å…ä½¿ç”¨ error typesï¼Œæˆ–è€…è‡³å°‘é¿å…å°†å®ƒä»¬ä½œä¸ºå…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚</p>
<h2 id="Opaque-errors"><a href="#Opaque-errors" class="headerlink" title="Opaque errors"></a>Opaque errors</h2><p>åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æ˜¯æœ€çµæ´»çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œå› ä¸ºå®ƒè§£é™¤äº†ä»£ç ä¸å®ƒçš„è°ƒç”¨è€…ä¹‹é—´çš„è€¦åˆï¼Œè¿™ç§é£æ ¼ç§°ä¸º opaque errors å¤„ç†ã€‚å› ä¸ºè™½ç„¶ä½ çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†ä½ æ— æ³•çœ‹åˆ°é”™è¯¯çš„å†…éƒ¨ï¼Œä½œä¸ºè°ƒç”¨è€…ï¼Œä½ åªçŸ¥é“æ“ä½œçš„ç»“æœåˆ°åº•æ˜¯æˆåŠŸäº†è¿˜æ˜¯å¤±è´¥äº†ã€‚è¿™å°±æ˜¯ opaque errors çš„å…¨éƒ¨å†…å®¹ï¼Œåªéœ€è¿”å›é”™è¯¯è€Œæ— éœ€å‡è®¾å…¶å†…å®¹ã€‚ å¦‚æœä½ é‡‡ç”¨æ­¤ç­–ç•¥ï¼Œé‚£ä¹ˆé”™è¯¯å¤„ç†ä½œä¸ºè°ƒè¯•è¾…åŠ©å·¥å…·å°†å˜å¾—æ›´åŠ æœ‰ç”¨ã€‚</p>
<p>è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="go">import â€œgithub.com/quux/barâ€

func fn() error &#123;
        x, err := bar.Foo()
        if err != nil &#123;
                return err
        &#125;
        // use x
&#125;</code></pre>
<p>ä¾‹å¦‚ï¼Œ<code>Foo</code> å£°æ˜çš„åˆçº¦ä¸ä¿è¯åœ¨é”™è¯¯çš„æƒ…å†µä¸‹å®ƒå°†è¿”å›ä»€ä¹ˆã€‚ <code>Foo</code> çš„ä½œè€…ç°åœ¨å¯ä»¥è‡ªç”±æ³¨é‡Šå¸¦æœ‰é™„åŠ ä¸Šä¸‹æ–‡çš„ä¼ é€’ç»™å®ƒçš„é”™è¯¯ï¼Œè€Œä¸ä¼šç ´åä¸è°ƒç”¨æ–¹çš„çº¦å®šã€‚</p>
<h3 id="æ³¨é‡Šé”™è¯¯"><a href="#æ³¨é‡Šé”™è¯¯" class="headerlink" title="æ³¨é‡Šé”™è¯¯"></a>æ³¨é‡Šé”™è¯¯</h3><p>ä¹Ÿå°±æ˜¯ç»™é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š</p>
<pre><code class="go">
func main() &#123;
    err := func1()
    if err != nil &#123;
        log.Print(err)
        return
    &#125;
&#125;

func func1() error &#123;
    ...
    return func2()
    ...
&#125;

func func2() error &#123;
    ...
    return func3()
    ...
&#125;

func func3() error &#123;
    ...
    err := ...
    if err != nil &#123;
        return err
    &#125;
    ...

    return nil
&#125;</code></pre>
<p>å‡è®¾ <code>main</code> æ‰§è¡Œåæ—¥å¿—æ‰“å°<code>No such file or directory</code>ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰æ–‡ä»¶å’Œç”Ÿæˆé”™è¯¯çš„è¡Œçš„ä¿¡æ¯ã€‚ï¼Œæ²¡æœ‰å¯¼è‡´é”™è¯¯çš„è°ƒç”¨å †æ ˆçš„å †æ ˆè·Ÿè¸ªã€‚ æˆ‘ä»¬å°†è¢«è¿«èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´æ¥è°ƒè¯•ã€è·Ÿè¸ªä»£ç ï¼Œä»¥å‘ç°å“ªä¸ªä»£ç è·¯å¾„è§¦å‘äº†è¿™ä¸ªé”™è¯¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å¯¹ä»£ç åšä¸€äº›æ”¹è¿›ï¼Œç»™å„ä¸ªå‡½æ•°è¿”å›çš„é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š</p>
<pre><code class="go">func main() &#123;
    err := func1()
    if err != nil &#123;
        log.Print(err)
        return
    &#125;
&#125;

func func1() error &#123;
    err := ...
    if err != nil &#123;
        return errors.Newf(&quot;func1 failed: %v&quot;, err)
    &#125;
    return func2()
&#125;

func func2() error &#123;
    err := ...
    if err != nil &#123;
        return errors.Newf(&quot;func2 failed: %v&quot;, err)
    &#125;
    return func3()
&#125;

func func3() error &#123;
    err := ...
    if err != nil &#123;
        return errors.Newf(&quot;func3 failed: %v&quot;, err)
    &#125;
    return nil
&#125;</code></pre>
<p>è¿™æ ·ï¼Œå½“ <code>main</code> å‡½æ•°æ‰“å°é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“åˆ°åº•æ˜¯å“ªä¸ªåœ°æ–¹å‡ºäº†é”™ï¼Œå°±èƒ½å¿«é€Ÿå®šä½åˆ°é—®é¢˜çš„æ‰€åœ¨ã€‚</p>
<p>ä½†æ˜¯ï¼Œæ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€çœ‹åˆ°çš„ï¼Œè¿™ç§æ¨¡å¼ä¸ä½¿ç”¨ Sentinel errors æˆ– Error types ä¸å…¼å®¹ï¼Œå› ä¸ºå°†é”™è¯¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå°†å…¶ä¸å¦ä¸€ä¸ªå­—ç¬¦ä¸²åˆå¹¶ï¼Œç„¶åä½¿ç”¨fmtå°†å…¶è½¬æ¢æˆä¸€ä¸ªæ–°çš„é”™è¯¯ï¼Œ ç ´åäº†åŸå§‹é”™è¯¯ä¸­çš„ä»»ä½•ä¸Šä¸‹æ–‡ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬é™·å…¥äº†ä¸€ä¸ªéå¸¸çŸ›ç›¾çš„å¤„å¢ƒï¼šæˆ‘ä»¬æ—¢å¸Œæœ›èƒ½é¿å…ä½¿ç”¨ sentinel errors å’Œ error types å¸¦æ¥çš„åŒ…ä¸åŒ…ä¹‹é—´çš„å¼ºè€¦åˆæ€§ï¼Œä¹Ÿå¸Œæœ›èƒ½æ‹¥æœ‰ opaque errors çš„çµæ´»æ€§ï¼Œæ¯”å¦‚ç»™é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½†åˆä¸æƒ³ç ´åäº†åŸå§‹é”™è¯¯ä¸­çš„ä»»ä½•ä¸Šä¸‹æ–‡ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿwrap errors æ¥å¸®å¿™ï¼</p>
<h3 id="Wrap-errors"><a href="#Wrap-errors" class="headerlink" title="Wrap errors"></a>Wrap errors</h3><p>é¡¾åæ€ä¹‰ï¼ŒWrap errors çš„æ„æ€å°±æ˜¯ç»™é”™è¯¯åšåŒ…è£…ã€‚Go ç¤¾åŒºçš„å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ <a target="_blank" rel="noopener" href="http://github.com/pkg/errors">pkg/errors</a> ï¼Œè¿™ä¸ªåº“æœ‰ä¸¤ä¸ªä¸»è¦å‡½æ•°ï¼š</p>
<pre><code class="go">// Wrap annotates cause with a message.
func Wrap(cause error, message string) error</code></pre>
<p>ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯ <code>Wrap</code>ï¼Œç»™å®ƒä¸€ä¸ªé”™è¯¯å’Œä¸€æ¡æ¶ˆæ¯ï¼Œå®ƒå°†äº§ç”Ÿä¸€ä¸ªæ–°çš„é”™è¯¯ã€‚</p>
<pre><code class="go">// Cause unwraps an annotated error.
func Cause(err error) error</code></pre>
<p>ç¬¬äºŒä¸ªå‡½æ•°æ˜¯ <code>Cause</code>ï¼Œç»™ä»–ä¸€ä¸ªå¯èƒ½åŒ…è£…æœ‰å…¶å®ƒé”™è¯¯çš„é”™è¯¯ï¼Œå®ƒå°†å…¶è§£åŒ…ä»¥æ‹¿åˆ°é‡Œå±‚åŸå§‹çš„é”™è¯¯ã€‚</p>
<p>ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç»™ä»»ä½•é”™è¯¯æ·»åŠ æ ‡è®°ï¼Œå¹¶åœ¨éœ€è¦æ£€æŸ¥æ—¶æ‹¿åˆ°åŸå§‹çš„æ ¹å› é”™è¯¯ã€‚ è€ƒè™‘è¿™ä¸ªå°†æ–‡ä»¶å†…å®¹è¯»å…¥å†…å­˜çš„å‡½æ•°çš„ç¤ºä¾‹ã€‚</p>
<pre><code class="go">func ReadFile(path string) ([]byte, error) &#123;
        f, err := os.Open(path)
        if err != nil &#123;
                return nil, errors.Wrap(err, &quot;open failed&quot;)
        &#125; 
        defer f.Close()

        buf, err := ioutil.ReadAll(f)
        if err != nil &#123;
                return nil, errors.Wrap(err, &quot;read failed&quot;)
        &#125;
        return buf, nil
&#125;</code></pre>
<p>æˆ‘ä»¬å°†ä½¿ç”¨æ­¤å‡½æ•°ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åä» <code>main</code> è°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<pre><code class="go">func ReadConfig() ([]byte, error) &#123;
        home := os.Getenv(&quot;HOME&quot;)
        config, err := ReadFile(filepath.Join(home, &quot;.settings.xml&quot;))
        return config, errors.Wrap(err, &quot;could not read config&quot;)
&#125;

func main() &#123;
        _, err := ReadConfig()
        if err != nil &#123;
                fmt.Println(err)
                os.Exit(1)
        &#125;
&#125;</code></pre>
<p>å¦‚æœ <code>ReadConfig</code> è¿”å›äº†é”™è¯¯ï¼Œç”±äºä½¿ç”¨äº†<code>errors.Wrap</code> ï¼Œæˆ‘ä»¬çš„å¾—åˆ°çš„é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å¾ˆå®Œå¤‡:</p>
<pre><code class="go">could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory</code></pre>
<p>å› ä¸º <code>errors.Wrap</code> ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯çš„å †æ ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¯¥å †æ ˆä»¥è·å–å…¶ä»–è°ƒè¯•ä¿¡æ¯ã€‚ </p>
<p>æˆ‘ä»¬å¼•å…¥äº†åŒ…è£…é”™è¯¯ä»¥äº§ç”Ÿå †æ ˆçš„æ¦‚å¿µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è®¨è®ºç›¸åçš„æƒ…å†µï¼Œå°†å®ƒä»¬å±•å¼€ã€‚ è¿™æ˜¯é”™è¯¯çš„åŸå› ã€‚åŸå› å‡½æ•°ã€‚</p>
<pre><code class="go">// IsTemporary returns true if err is temporary.
func IsTemporary(err error) bool &#123;
        te, ok := errors.Cause(err).(temporary)
        return ok &amp;&amp; te.Temporary()
&#125;</code></pre>
<p>åœ¨æ“ä½œä¸­ï¼Œæ¯å½“éœ€è¦æ£€æŸ¥ä¸ç‰¹å®šå€¼æˆ–ç±»å‹åŒ¹é…çš„é”™è¯¯æ—¶ï¼Œéƒ½åº”é¦–å…ˆä½¿ç”¨ <code>errors.Cause</code> å‡½æ•°æ¢å¤åŸå§‹é”™è¯¯ã€‚</p>
<p><a target="_blank" rel="noopener" href="http://github.com/pkg/errors">pkg/errors</a> è§£å†³äº†æˆ‘ä»¬çš„éš¾é¢˜ï¼Œé‚£ä¹ˆå®ƒçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿå¾ˆç®€å•ï¼š</p>
<pre><code class="go">// Wrap returns an error annotating err with a stack trace
// at the point Wrap is called, and the supplied message.
// If err is nil, Wrap returns nil.
func Wrap(err error, message string) error &#123;
    if err == nil &#123;
        return nil
    &#125;
    err = &amp;withMessage&#123;
        cause: err,
        msg:   message,
    &#125;
    return &amp;withStack&#123;
        err,
        callers(),
    &#125;
&#125;</code></pre>
<p>å®ƒçš„å·¥ä½œåŸç†ä»å®ƒçš„åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼šæŠŠåŸå§‹é”™è¯¯å°è£…åœ¨æ–°é”™è¯¯çš„ <code>cause</code> å­—æ®µï¼Œ<code>withMessage</code> å’Œ <code>withStack</code> éƒ½å®ç°äº†æ­¤æ¥å£ï¼š</p>
<pre><code class="go">type causer interface &#123;
        Cause() error
    &#125;</code></pre>
<p>å†æ¥çœ‹ <code>Cause</code> å‡½æ•°ï¼š</p>
<pre><code class="go">// Cause returns the underlying cause of the error, if possible.
// An error value has a cause if it implements the following
// interface:
//
//     type causer interface &#123;
//            Cause() error
//     &#125;
//
// If the error does not implement Cause, the original error will
// be returned. If the error is nil, nil will be returned without further
// investigation.
func Cause(err error) error &#123;
    type causer interface &#123;
        Cause() error
    &#125;

    for err != nil &#123;
        cause, ok := err.(causer)
        if !ok &#123;
            break
        &#125;
        err = cause.Cause()
    &#125;
    return err
&#125;</code></pre>
<p><code>Cause</code> è·å–åŸå§‹çš„é”™è¯¯ï¼Œé¦–å…ˆå°±æ˜¯çœ‹ç»è¿‡ä¿è¯çš„é”™è¯¯æœ‰æ²¡æœ‰å®ç° <code>causer</code> æ¥å£ï¼Œæœ‰çš„è¯è°ƒç”¨ <code>Cause()</code> è¿”å›å°±æ‹¿åˆ°äº†åŸå§‹çš„é”™è¯¯ã€‚</p>
<p>åœ¨ wrap errors ä¸­ä½¿ç”¨ sentinel errors</p>
<p>åœ¨ä½¿ç”¨ wrap errors æ—¶ï¼Œåœ¨å°‘æ•°æƒ…å†µæˆ‘ä»¬è¿˜éœ€è¦ç”¨åˆ° sentinel errorsï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>errors.Is(err, target error) bool</code>ï¼Œå®ƒå¯ä»¥åˆ¤æ–­ä¸€ä¸ªé”™è¯¯çš„é“¾é‡Œæ˜¯å¦æœ‰ä»»ä½•é”™è¯¯æ˜¯è·Ÿ <code>target</code> æ˜¯åŒ¹é…çš„ã€‚</p>
<p>åœ¨ wrap errors ä¸­ä½¿ç”¨ error types</p>
<p>åœ¨å°‘æ•°æƒ…å†µæˆ‘ä»¬è¿˜éœ€è¦ç”¨åˆ° error typesï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>errors.As(err error, target interface&#123;&#125;) bool</code>ï¼Œå®ƒå¯ä»¥åˆ¤æ–­ä¸€ä¸ªé”™è¯¯çš„é“¾é‡Œçš„ç¬¬ä¸€ä¸ªè·Ÿ <code>target</code> åŒç±»å‹çš„é”™è¯¯ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°†é”™è¯¯å€¼èµ‹å€¼ç»™ <code>target</code> å¹¶è¿”å› <code>true</code>ã€‚</p>
<h3 id="Wrap-errors-æœ€ä½³å®è·µ"><a href="#Wrap-errors-æœ€ä½³å®è·µ" class="headerlink" title="Wrap errors æœ€ä½³å®è·µ"></a>Wrap errors æœ€ä½³å®è·µ</h3><p>ä»€ä¹ˆæ ·çš„ wrap errors é”™è¯¯å¤„ç†å®è·µæ‰æ˜¯å¥½çš„ï¼Ÿæˆ‘ä»¬è‚¯å®šä¼šå›ç­”è¯´èƒ½å¸®åŠ©æˆ‘ä»¬å®šä½åˆ°é”™è¯¯ç°åœºçš„å°±æ˜¯å¥½çš„ï¼Œè€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="go">func main() &#123;
    err := func1()
    if err != nil &#123;
        log.Print(err)
        return
    &#125;
&#125;

func func1() error &#123;
    err := ...
    if err != nil &#123;
        return err
    &#125;
    return func2()
&#125;

func func2() error &#123;
    err := ...
    if err != nil &#123;
        return err
    &#125;
    return func3()
&#125;

func func3() error &#123;
    err := ...
    if err != nil &#123;
        return err
    &#125;
    return nil
&#125;</code></pre>
<p>å‡è®¾ <code>main</code> å‡½æ•°æ‰§è¡Œåæ‰“å°äº†é”™è¯¯ï¼š<code>No such file or directory</code>ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªé”™è¯¯å¤„ç†æ–¹å¼æ— æ³•å¸®åŠ©æˆ‘ä»¬å®šä½åˆ°é”™è¯¯ç°åœºã€‚è€Œè¦æ‰¾åˆ°è¿™ç§ä»£ç é‡Œçš„é”™è¯¯çš„ä»£ä»·ä¹Ÿå¤ªå¤§äº†ç‚¹ï¼Œå¯¹äºä¸€ä¸ªä»£ç é‡å¤šã€åŠŸèƒ½å¤æ‚çš„åº”ç”¨ï¼Œæˆ‘ä»¬å¯èƒ½è¦ç»å†ï¼šä¿®æ”¹ä»£ç  â†’ æäº¤MR â†’ ç­‰å¾…ä»£ç å¾—åˆ° review â†’ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒã€‚</p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬å­¦ä¼šäº†å°†ä»£ç æ”¹è¿›æˆï¼š</p>
<pre><code class="go">func main() &#123;
    err := func1()
    if err != nil &#123;
        log.Print(err)
        return
    &#125;
&#125;

func func1() error &#123;
    err := ... // func1 äº§ç”Ÿçš„é”™è¯¯
    if err != nil &#123;
        return fmt.Errorf(&quot;func1 error: %v&quot;, err)
    &#125;
    return func2()
&#125;

func func2() error &#123;
    err := ... // func2 äº§ç”Ÿçš„é”™è¯¯
    if err != nil &#123;
        return fmt.Errorf(&quot;func2 error: %v&quot;, err)
    &#125;
    return func3()
&#125;

func func3() error &#123;
    err := ...
    if err != nil &#123;
        return fmt.Errorf(&quot;func3 error: %v&quot;, err)
    &#125;
    return nil
&#125;</code></pre>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå½“ <code>main</code> æ‰“å°äº†é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬ä¾¿èƒ½ä¸€çœ¼å®šä½åˆ°é”™è¯¯ç°åœºã€‚</p>
<p>ä¸Šè¾¹æˆ‘ä»¬æ˜¯é€šè¿‡ç»™é”™è¯¯æ·»åŠ æ³¨é‡Š/ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè®©é”™è¯¯ä¿¡æ¯æˆä¸ºä¸€ä¸ªé”™è¯¯çš„ identifitionã€‚æŠŠæ§ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å¤šå°‘å¾ˆå…³é”®ï¼Œæ—¢ä¸èƒ½å¤šäº†ï¼Œä¹Ÿä¸èƒ½å°‘äº†ï¼Œåªèƒ½æ˜¯åˆšåˆšå¥½ã€‚å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿä»æ•´ä¸ªè°ƒç”¨é“¾çš„è§’åº¦å»è€ƒè™‘ï¼Œè€Œä¸æ˜¯åªçœ‹åˆ°ä¸€ä¸ªç‚¹ ï¼š</p>
<pre><code class="go">func func3() error &#123;
    err := ...
    if err != nil &#123;
        return fmt.Errorf(&quot;func3 error: %v&quot;, err)
    &#125;
    return nil
&#125;</code></pre>
<p><code>func3</code> çš„ä½œè€…å·²ç»å°†è¿™ä¸ªå‡½æ•°è¿”å›çš„é”™è¯¯éƒ½åŠ ä¸Šä¸‹æ–‡äº†ï¼Œå› æ­¤ <code>func3</code> çš„è°ƒç”¨è€…ä¹Ÿå°±æ²¡å¿…è¦å†ç»™é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡äº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹æŠ€å·§ï¼š</p>
<ol>
<li><p>åœ¨å›¢é˜Ÿçš„é¡¹ç›®ä¸­ï¼Œä¸šåŠ¡ä»£ç ä½¿ç”¨ <code>errors.New</code> æˆ–è€… <code>errors.Newf</code>ç”Ÿæˆä¸€ä¸ªæ–°çš„é”™è¯¯å¹¶è¿”å›ï¼š</p>
<pre><code class="go">func parseArgs(args []string) error &#123;
    if len(args) &lt; 3 &#123;
        return errors.Newf(&quot;args length is %d, expect %d&quot;, len(args), 3)
    &#125;
&#125;</code></pre>
</li>
<li><p>åœ¨å›¢é˜Ÿçš„é¡¹ç›®ä¸­ï¼Œè°ƒç”¨åŒé¡¹ç›®å†…çš„å‡½æ•°é‡åˆ°é”™è¯¯ï¼Œé€šå¸¸ç›´æ¥è¿”å›é”™è¯¯ã€‚å› ä¸ºæŒ‰ç…§ä¸Šé¢ç¬¬ 1 ç‚¹ï¼Œä½ å¾—åˆ°çš„é”™è¯¯å·²ç»æ˜¯ä¸€ä¸ªå·²ç»åŠ äº†ä¸Šä¸‹æ–‡ä¿¡æ¯çš„é”™è¯¯ï¼Œæ‰€ä»¥æ— éœ€å†é‡å¤æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š</p>
<pre><code class="go">err := parseArgs()
if err != nil &#123;
    return err
&#125;</code></pre>
</li>
<li><p>åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œ ä¸æ ‡å‡†åº“æˆ–è€…ç¬¬ä¸‰æ–¹çš„åº“ï¼ˆGitHub ä¸Šçš„ ï¼‰è¿›è¡Œåä½œçš„æ—¶å€™ï¼Œè€ƒè™‘ä½¿ç”¨ <code>errors.Wrap</code> æˆ–è€… <code>errors.Wrapf</code>åŒ…è£…é”™è¯¯ä»¥ä¿å­˜å †æ ˆä¿¡æ¯ï¼š</p>
<pre><code class="go">f, err := os.Open(path)
if err != nil &#123;
    return errors.Wrapf(err, &quot;open file %q&quot;, path)
&#125;</code></pre>
</li>
<li><p>è°ƒç”¨é“¾çš„ä¸­é—´èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªé”™è¯¯äº§ç”Ÿçš„åœ°æ–¹å¯¼å‡ºæ‰“å°æ—¥å¿—ï¼Œæœ€ç»ˆåœ¨è°ƒç”¨é“¾çš„å¼€å§‹å¤„ä½¿ç”¨ <code>%+v</code> æŠŠå †æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ï¼š</p>
<pre><code class="go">func main() &#123;
    err := app.Run()
    if err != nil &#123;
        log.Print(err)
        os.Exit(1)
    &#125;
&#125;</code></pre>
</li>
<li><p>å®åœ¨éœ€è¦ä½¿ç”¨ sentinel error æˆ–è€… error types çš„åœ°æ–¹ï¼Œä½¿ç”¨ <code>errors.Cause</code> è·å–æ ¹å› é”™è¯¯ï¼Œå†å’Œ sentinel error åšç­‰å€¼æ¯”è¾ƒæˆ–è€…åš type assertionï¼›</p>
</li>
<li><p>éä¸šåŠ¡ä»£ç ã€åŸºç¡€å…¬å…±åº“ç­‰ä»£ç ï¼Œç›´æ¥è¿”å›åŸå§‹é”™è¯¯å³å¯ï¼Œè®©è°ƒç”¨æ–¹è´Ÿè´£ç»™é”™è¯¯åŠ ä¸Šä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
</li>
</ol>
<h3 id="æ–­è¨€é”™è¯¯çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç±»å‹"><a href="#æ–­è¨€é”™è¯¯çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç±»å‹" class="headerlink" title="æ–­è¨€é”™è¯¯çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç±»å‹"></a>æ–­è¨€é”™è¯¯çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç±»å‹</h3><p>åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œopaque error è¿™ç§éæ­¤å³å½¼çš„é”™è¯¯å¤„ç†æ–¹æ³•æ˜¯ä¸å¤Ÿçš„ã€‚æœ‰ä¸€äº›åœºæ™¯æˆ‘ä»¬æ˜¯éœ€è¦è¯¦ç»†çš„ error ä¿¡æ¯çš„ã€åº•å±‚çš„é”™è¯¯ï¼Œ</p>
<p>ä¾‹å¦‚ï¼Œä¸è¿›ç¨‹å¤–çš„ä¸–ç•Œè¿›è¡Œäº¤äº’ï¼Œéœ€è¦è°ƒç”¨æ–¹è°ƒæŸ¥é”™è¯¯çš„æ€§è´¨ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦é‡è¯•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ£€æŸ¥é”™è¯¯å®ç°äº†ç‰¹å®šçš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯æ–­è¨€é”™è¯¯æ˜¯ç‰¹å®šçš„ç±»å‹æˆ–å€¼ã€‚è€ƒè™‘è¿™ä¸ªä¾‹å­:</p>
<pre><code class="go">package net

// An Error represents a network error.
type Error interface &#123;
    error
    Timeout() bool   // Is the error a timeout?
    Temporary() bool // Is the error temporary?
&#125;</code></pre>
<p>è¿™æ˜¯ net çš„ Error æ¥å£ï¼Œ</p>
<pre><code class="go">if nerr, ok := err.(net.Error); ok &amp;&amp; nerr.Temporary() &#123;
    time.Sleep(1e9)
    continue
&#125;
if err != nil &#123;
    log.Fatal(err)
&#125;</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬åˆ¤æ–­ err æ˜¯å¦æ˜¯ <code>net.Error</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œæ˜¯ä¸æ˜¯ temporary é”™è¯¯ï¼Œ</p>
<pre><code class="go">// main.go

type temporary interface &#123;
    Temporary() bool
&#125;

func IsTemporary(err error) bool &#123;
    te, ok := err.(temporary)
    return ok &amp;&amp; te.Temporary()
&#125;

func main() &#123;
    err := ...
    if IsTemporary(err) &#123; 
        // å‡è®¾åœ¨è¿™é‡Œæˆ‘ä»¬è¦åˆ¤æ–­ err æ˜¯å¦æ˜¯ net.Error çš„ Temporary
        // é€šè¿‡åœ¨ä¸Šè¾¹å®šä¹‰äº†ä¸€ä¸ª temporary æ¥å£å’Œ IsTemporary æ–¹æ³•
        // æˆ‘ä»¬æ— éœ€å¯¼å…¥ net åŒ…å³å¯åˆ¤æ–­ err æ˜¯å¦æ˜¯ Temporary è¿™ä¸ªè¡Œä¸º

    &#125;
&#125;</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨æœ¬åœ°å£°æ˜äº†ä¸€ä¸ª <code>temporary</code> æ¥å£ï¼Œç”¨äºæ–­è¨€ err æ˜¯å¦å…·æœ‰ <code>temporary</code> çš„è¿™ä¸ªè¡Œä¸ºã€‚è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œå¯ä»¥åœ¨ä¸å¯¼å…¥å®šä¹‰é”™è¯¯çš„ç¨‹åºåŒ…æˆ–å®é™…ä¸Šä¸äº†è§£æœ‰å…³é”™è¯¯åº•å±‚ç±»å‹çš„ä»»ä½•ä¿¡æ¯çš„æƒ…å†µä¸‹å®ç°æ­¤é€»è¾‘ï¼Œæˆ‘ä»¬åªæ˜¯å¯¹å…¶è¡Œä¸ºæ„Ÿå…´è¶£ã€‚</p>
<h3 id="error-å¤„ç†åº“çš„é€‰æ‹©"><a href="#error-å¤„ç†åº“çš„é€‰æ‹©" class="headerlink" title="error å¤„ç†åº“çš„é€‰æ‹©"></a>error å¤„ç†åº“çš„é€‰æ‹©</h3><p><a target="_blank" rel="noopener" href="https://github.com/pkg/errors">pkg/errors</a> åœ¨ Go ç¤¾åŒºè¢«å¹¿æ³›ä½¿ç”¨ï¼Œå€ŸåŠ©è¿™ä¸ªåº“æˆ‘ä»¬å°±èƒ½æ–¹ä¾¿åœ°åº”ç”¨ä¸Šè¿°çš„é”™è¯¯å¤„ç†å®è·µæ–¹å¼ã€‚å¦å¤–ç¤¾åŒºä¹Ÿæœ‰ä¸€äº›åŸºäº pkg/errors ä¸æ–­æ‰©å±•çš„åº“ï¼Œæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://github.com/cockroachdb/errors">cockroachdb/errors</a>ï¼Œæä¾›äº†éå¸¸å¤šçš„<a target="_blank" rel="noopener" href="https://github.com/cockroachdb/errors">ç‰¹æ€§</a>ï¼Œéå¸¸å€¼å¾—ä¸€è¯•ã€‚</p>
<h1 id="Error-å¤„ç†æŠ€å·§"><a href="#Error-å¤„ç†æŠ€å·§" class="headerlink" title="Error å¤„ç†æŠ€å·§"></a>Error å¤„ç†æŠ€å·§</h1><h2 id="Fail-fast-å°½æ—©å¤„ç†é”™è¯¯"><a href="#Fail-fast-å°½æ—©å¤„ç†é”™è¯¯" class="headerlink" title="Fail-fast: å°½æ—©å¤„ç†é”™è¯¯"></a>Fail-fast: å°½æ—©å¤„ç†é”™è¯¯</h2><p>Go ä»£ç é‡Œ <code>if err != nil &#123;&#125;</code> ä¼šéå¸¸å¤šï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ¯æ¬¡é‡åˆ°é”™è¯¯æ—¶å°±ç«‹é©¬å¤„ç†é”™è¯¯å¹¶ç»ˆæ­¢æ‰§è¡Œæµç¨‹ï¼Œé¿å…æœ‰è¿‡å¤šçš„åµŒå¥—ä»£ç å—ã€‚ç¤ºä¾‹ï¼š</p>
<pre><code class="go">// do this
f, err := func1()
if err != nil &#123;
    // å¤„ç†é”™è¯¯
&#125;

// æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹
err = func1()
if err != nil &#123;
    // å¤„ç†é”™è¯¯
&#125;

// æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹
err = func3()
if err != nil &#123;
    // å¤„ç†é”™è¯¯
&#125;

// æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹

...

return nil

// ====== åˆ†å‰²çº¿ ======

// don&#39;t do this
f, err := os.func1()
if err == nil &#123;
    // æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹
    err = func2()
    if err == nil &#123;
        // æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹
        err = func3()
        if err == nil &#123;
            // æ²¡æœ‰é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹
            return nil
        &#125;
        // æœ‰é”™è¯¯ï¼Œå¤„ç†é”™è¯¯
    &#125;
        // æœ‰é”™è¯¯ï¼Œå¤„ç†é”™è¯¯
&#125;
// æœ‰é”™è¯¯ï¼Œå¤„ç†é”™è¯¯</code></pre>
<p>è¿™ä¸¤ç§å†™æ³•ä¸­ç¬¬ 1 ç§æ›´åˆç†ï¼Œä¸”å¯è¯»æ€§æ›´å¥½ï¼›ç¬¬ 2 ç§å†™æ³•æ˜¯ç³Ÿç³•çš„ï¼Œä»£ç æœ‰å¾ˆå¤šç¼©è¿›å—ï¼Œå¯è¯»æ€§å¾ˆå·®ã€‚äººè„‘å¤©ç”Ÿä¸é€‚åˆå»ç†è§£è¿™ç§å±‚å±‚åµŒå¥—çš„ä¸œè¥¿ï¼ˆæƒ³æƒ³é€’å½’å‡½æ•°ï¼Œä½ èƒ½å¾€è„‘è¢‹é‡Œå‹è¿›æ‰€æœ‰çš„é€’å½’è°ƒç”¨å—ğŸ˜‚ï¼‰ã€‚</p>
<h2 id="é€šè¿‡å‡å°‘é”™è¯¯å‡ºç°çš„æ¬¡æ•°çš„æ–¹å¼å»å‡å°‘é”™è¯¯å¤„ç†çš„æ¬¡æ•°"><a href="#é€šè¿‡å‡å°‘é”™è¯¯å‡ºç°çš„æ¬¡æ•°çš„æ–¹å¼å»å‡å°‘é”™è¯¯å¤„ç†çš„æ¬¡æ•°" class="headerlink" title="é€šè¿‡å‡å°‘é”™è¯¯å‡ºç°çš„æ¬¡æ•°çš„æ–¹å¼å»å‡å°‘é”™è¯¯å¤„ç†çš„æ¬¡æ•°"></a>é€šè¿‡å‡å°‘é”™è¯¯å‡ºç°çš„æ¬¡æ•°çš„æ–¹å¼å»å‡å°‘é”™è¯¯å¤„ç†çš„æ¬¡æ•°</h2><p>è¦è¿™æ ·å­ï¼š</p>
<pre><code class="go">func AuthenticateRequest(r *Request) error &#123;
    return authenticate(r.User)
&#125;</code></pre>
<p>ä¸è¦è¿™æ ·å­ï¼š</p>
<pre><code class="go">func AuthenticateRequest(r *Request) error &#123;
    err := authenticate(r.User)
    if err != nil &#123;
        return err
    &#125;
    return nil
&#125;</code></pre>
<p>æ¥çœ‹ä¸€ä¸ª Rob Pike çš„ä¾‹å­ï¼š</p>
<pre><code class="go">_, err = fd.Write(p0[a:b])
if err != nil &#123;
    return err
&#125;
_, err = fd.Write(p1[c:d])
if err != nil &#123;
    return err
&#125;
_, err = fd.Write(p2[e:f])
if err != nil &#123;
    return err
&#125;
// and so on</code></pre>
<p>è¿™æ®µä»£ç æœ‰ 3 ä¸ªé”™è¯¯æ˜¯å¦ä¸º nil çš„æ£€æŸ¥ï¼Œè¿™äº›é‡å¤ã€ç¹ççš„ä»£ç è®©ä»£ç å¤±å»äº†ä¼˜é›…ã€‚åº”ç”¨åŒæ ·çš„åŸç†ï¼Œè¿™æ®µä»£ç å¯ä»¥ä¼˜åŒ–ä¸ºï¼š</p>
<pre><code class="go">type errWriter struct &#123;
    w   io.Writer
    err error
&#125;

func (ew *errWriter) write(buf []byte) &#123;
    if ew.err != nil &#123;
        return
    &#125;
    _, ew.err = ew.w.Write(buf)
&#125;

ew := &amp;errWriter&#123;w: fd&#125;
ew.write(p0[a:b])
ew.write(p1[c:d])
ew.write(p2[e:f])
// and so on
if ew.err != nil &#123;
    return ew.err
&#125;</code></pre>
<p>æœ€åå¾—åˆ°çš„ä»£ç æ›´åŠ ç®€æ´ã€ä¼˜é›…ã€‚</p>
<h2 id="Only-handle-errors-once"><a href="#Only-handle-errors-once" class="headerlink" title="Only handle errors once"></a>Only handle errors once</h2><p>Dave Cheney åœ¨ä¸­æåˆ°ï¼Œæˆ‘ä»¬åªåº”è¯¥å¤„ç†é”™è¯¯ä¸€æ¬¡ã€‚å¤„ç†é”™è¯¯æ„å‘³ç€æ£€æŸ¥é”™è¯¯å€¼å¹¶åšå‡ºå†³å®šã€‚è¿™å¥è¯çš„æ„æ€æ¯ä¸€æ¬¡æ£€æŸ¥é”™è¯¯ï¼Œæˆ‘ä»¬åªåº”è¯¥åšå‡ºä¸€ä¸ªé€‰æ‹©ã€‚</p>
<p>å¯¹äºä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœä½ åšå‡ºå°‘äºä¸€æ¬¡çš„é€‰æ‹©ï¼ˆæ²¡æœ‰æ¥æ”¶å‡½æ•°è¿”å›çš„ errorï¼Œæˆ–è€…æ¥æ”¶äº†ä½†ä¸å¤„ç†ï¼‰ï¼Œä½ å°±æ˜¯åœ¨å¿½ç•¥é”™è¯¯ã€‚å°±åƒæˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„ï¼Œ<code>w.Write</code> è¿”å›çš„é”™è¯¯æ²¡æœ‰è¢«æ¥æ”¶ï¼š</p>
<pre><code class="go">func Write(w io.Writer, buf []byte) &#123;
        w.Write(buf)
&#125;</code></pre>
<p>å¯¹äºä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœä½ åšå‡ºå¤šäºä¸€æ¬¡çš„é€‰æ‹©ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼š</p>
<pre><code class="go">func Write(w io.Writer, buf []byte) error &#123;
        _, err := w.Write(buf)
        if err != nil &#123;
                // annotated error goes to log file
                log.Println(&quot;unable to write:&quot;, err)

                // unannotated error returned to caller
                return err
        &#125;
        return nil
&#125;</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœ <code>w.Write</code> è¿”å›äº†ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆä»£ç ä¼šæ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œæ¥ä¸‹æ¥è¿™ä¸ªé”™è¯¯è¢«è¿”å›ç»™ <code>Write</code> çš„è°ƒç”¨è€…ï¼Œè€Œ <code>Write</code> çš„è°ƒç”¨è€…ä¹Ÿæœ‰å¯èƒ½ä¼šåšåŒæ ·çš„æ“ä½œï¼šæ‰“å°æ—¥å¿—ï¼Œç„¶åç»§ç»­å‘ä¸Šé€ä¼ ã€‚è€Œè°ƒç”¨è€…çš„è°ƒç”¨è€…ä¹ŸåšåŒæ ·çš„äº‹æƒ…ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°è¾¾åˆ°è°ƒç”¨é“¾çš„å¼€å§‹ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å¾—åˆ°äº†å¤šä½™çš„ã€é‡å¤çš„æ—¥å¿—æ‰“å°ï¼Œè¿™æ˜¯å¾ˆç³Ÿç³•çš„ï¼Œæ— ç›Šäºæˆ‘ä»¬è·Ÿè¸ªé”™è¯¯ã€‚è€Œä¸”åœ¨è°ƒç”¨é“¾çš„å¼€å§‹å¤„ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯æ²¡æœ‰ä»»ä½•ä¸Šä¸‹æ–‡çš„åŸå§‹é”™è¯¯ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•åˆ¤æ–­é”™è¯¯æ˜¯ä»è°ƒç”¨é“¾ä¸­çš„å“ªä¸€ä¸ªèŠ‚ç‚¹æŠ›å‡ºçš„ã€‚<code>Wrap errors</code> è¿™ä¸ªæ—¶å€™æ´¾ä¸Šäº†ç”¨åœºï¼š</p>
<pre><code class="go">func Write(w io.Write, buf []byte) error &#123;
        _, err := w.Write(buf)
        return errors.Wrap(err, &quot;write failed&quot;)
&#125;</code></pre>
<p>ä½¿ç”¨ errors packageï¼Œç»™é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿™æ ·ç¨‹åºå‘˜å’Œæœºå™¨éƒ½æ˜¯å¾ˆå¥½åœ°æ£€æŸ¥é”™è¯¯ã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.golang.org/errors-are-values">Errors are values</a></li>
<li><a target="_blank" rel="noopener" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Donâ€™t just check errors, handle them gracefully</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.golang.org/error-handling-and-go">Error handling and Go</a></li>
<li><a target="_blank" rel="noopener" href="https://u.geekbang.org/subject/go">Goè¿›é˜¶è®­ç»ƒè¥</a></li>
</ul>
</div></div></body><script src="/js/highlight.min.js"></script><script src="/js/main.js"></script><script src="/js/bootstrap/bootstrap.min.js"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '');</script></html>